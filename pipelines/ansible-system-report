stage('Run Enterprise Audit') {
    steps {
        withCredentials([file(credentialsId: 'automation-key', variable: 'ANSIBLE_KEY_FILE')]) {
            script {

                def hosts = params.SERVER_NAME.replace(';', ',')

                def rc = sh(
                    script: """
                        echo "Running Ansible Audit on: ${hosts}"

                        ansible-playbook \
                            -i inventory/hosts \
                            playbooks/auditreport1.yml \
                            --private-key="\$ANSIBLE_KEY_FILE" \
                            -e "hosts=${hosts}"
                    """,
                    returnStatus: true
                )

                echo "Ansible Exit Code: ${rc}"

                if (rc == 0) {
                    echo "Audit completed successfully."
                } else if (rc == 2) {
                    unstable("Audit completed with changes.")
                } else {
                    error("Audit failed with exit code ${rc}")
                }
            }
        }
    }
}
