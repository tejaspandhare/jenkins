---
- name: Enterprise Full Linux Audit Report - Production
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    report_dir: "{{ playbook_dir }}/../reports"
    valid_users: []
    final_users: []
    report_data: []
    disk_info: []

  tasks:

  ########################################################
  # ENSURE REPORT DIRECTORY EXISTS (LOCAL)
  ########################################################

  - name: Create reports directory
    run_once: true
    delegate_to: localhost
    become: false
    file:
      path: "{{ report_dir }}"
      state: directory
      mode: '0755'

  ########################################################
  # SYSTEM INFORMATION
  ########################################################

  - name: Collect hardware vendor
    command: cat /sys/devices/virtual/dmi/id/sys_vendor
    register: sys_vendor
    ignore_errors: yes
    changed_when: false

  - name: Collect hardware model
    command: cat /sys/devices/virtual/dmi/id/product_name
    register: sys_model
    ignore_errors: yes
    changed_when: false

  - name: Set system information
    set_fact:
      system_info:
        host: "{{ inventory_hostname }}"
        os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
        kernel: "{{ ansible_kernel }}"
        cpu: "{{ ansible_processor_vcpus }}"
        ram: "{{ ansible_memtotal_mb }} MB"
        make: "{{ sys_vendor.stdout | default('N/A') }}"
        model: "{{ sys_model.stdout | default('N/A') }}"

  ########################################################
  # REPORT GENERATION (LOCAL CONTROLLER)
  ########################################################

  - name: Remove old reports
    run_once: true
    delegate_to: localhost
    become: false
    file:
      path: "{{ item }}"
      state: absent
    loop:
      - "{{ report_dir }}/system_report.txt"
      - "{{ report_dir }}/system_report.csv"
      - "{{ report_dir }}/system_report.html"

  - name: Generate TXT report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ report_dir }}/system_report.txt"
      content: |
        ================= FULL SYSTEM AUDIT REPORT =================
        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}
        Host: {{ sys.host }}
        OS: {{ sys.os }}
        Kernel: {{ sys.kernel }}
        CPU: {{ sys.cpu }}
        RAM: {{ sys.ram }}
        Make: {{ sys.make }}
        Model: {{ sys.model }}
        ------------------------------------------------------------
        {% endfor %}

  - name: Generate CSV report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ report_dir }}/system_report.csv"
      content: |
        Host,OS,Kernel,CPU,RAM,Make,Model
        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}
        {{ sys.host }},{{ sys.os }},{{ sys.kernel }},{{ sys.cpu }},{{ sys.ram }},{{ sys.make }},{{ sys.model }}
        {% endfor %}

  - name: Generate HTML report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ report_dir }}/system_report.html"
      content: |
        <html>
        <body>
        <h2>Enterprise Linux Audit Report</h2>
        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}
        <h3>{{ sys.host }}</h3>
        <ul>
          <li>OS: {{ sys.os }}</li>
          <li>Kernel: {{ sys.kernel }}</li>
          <li>CPU: {{ sys.cpu }}</li>
          <li>RAM: {{ sys.ram }}</li>
          <li>Make: {{ sys.make }}</li>
          <li>Model: {{ sys.model }}</li>
        </ul>
        <hr>
        {% endfor %}
        </body>
        </html>
