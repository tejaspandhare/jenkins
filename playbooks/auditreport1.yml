---
- name: Enterprise Linux Security & Compliance Audit
  hosts: "{{ hosts.split(';') }}"
  become: yes
  gather_facts: yes

  vars:
    valid_users: []
    final_users: []
    report_data: []

  tasks:

  ########################################################
  # LAST PATCH DATE
  ########################################################

  - name: Get last patch date (RHEL)
    shell: rpm -qa --last | head -1 | awk '{print $3"-"$2"-"$6}'
    register: last_patch_rhel
    when: ansible_os_family == "RedHat"
    changed_when: false
    ignore_errors: yes

  - name: Get last apt upgrade date (Debian)
    shell: grep "upgrade " /var/log/apt/history.log | tail -1 | cut -d' ' -f1
    register: last_patch_debian
    when: ansible_os_family == "Debian"
    changed_when: false
    ignore_errors: yes

  - name: Set last patch fact
    set_fact:
      last_patch: >-
        {{
          (last_patch_rhel.stdout if ansible_os_family == "RedHat" else
           last_patch_debian.stdout if ansible_os_family == "Debian" else
           "N/A") | default("N/A")
        }}

  ########################################################
  # SYSTEM INFO
  ########################################################

  - name: Set system info
    set_fact:
      system_info:
        host: "{{ inventory_hostname }}"
        os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
        kernel: "{{ ansible_kernel }}"
        machine_type: "{{ ansible_virtualization_type | default('physical') }}"
        cpu: "{{ ansible_processor_vcpus }}"
        ram_total: "{{ ansible_memtotal_mb }}"
        ram_used: "{{ ansible_memtotal_mb - ansible_memavailable_mb }}"
        uptime_days: "{{ (ansible_uptime_seconds // 86400) }}"
        load_avg: "{{ ansible_loadavg['1m'] }}"
        last_patch: "{{ last_patch }}"

  ########################################################
  # DISK INFO WITH ALERT LOGIC
  ########################################################

  - name: Build disk info list
    set_fact:
      disk_info: "{{ disk_info | default([]) + [ disk_entry ] }}"
    vars:
      used_percent: "{{ ((item.size_total-item.size_available)/item.size_total*100)|round(1) }}"
      disk_entry:
        mount: "{{ item.mount }}"
        size: "{{ (item.size_total/1024/1024/1024)|round(2) }}"
        used: "{{ used_percent }}"
        alert: "{{ 'YES' if used_percent|float > 80 else 'NO' }}"
    loop: "{{ ansible_mounts }}"
    when:
      - item.fstype not in ['tmpfs','devtmpfs','overlay']
      - not item.mount.startswith('/run')

  ########################################################
  # SUDO USERS
  ########################################################

  - name: Get passwd entries
    getent:
      database: passwd

  - name: Get group entries
    getent:
      database: group

  - name: Build valid local users (UID >=1000)
    set_fact:
      valid_users: "{{ valid_users + [ item.key ] }}"
    loop: "{{ getent_passwd | dict2items }}"
    when:
      - item.value[2] | int >= 1000
      - item.key != "nobody"

  - name: Build sudo group list
    set_fact:
      sudo_group_users: >-
        {{
          (getent_group['sudo'][2].split(',') if 'sudo' in getent_group else []) +
          (getent_group['wheel'][2].split(',') if 'wheel' in getent_group else [])
        }}

  - name: Keep only sudo users
    set_fact:
      final_users: "{{ valid_users | intersect(sudo_group_users | default([])) }}"

  - name: Collect sudo user details
    shell: |
      LASTLOGIN=$(lastlog -u {{ item }} | tail -1 | awk '{$1=$2=$3=""; print $0}')
      PASSMAX=$(chage -l {{ item }} | grep "Maximum")
      echo "{{ item }}|$LASTLOGIN|$PASSMAX"
    loop: "{{ final_users }}"
    register: user_output
    changed_when: false
    when: final_users | length > 0

  - name: Store user data
    set_fact:
      report_data: "{{ user_output.results | map(attribute='stdout') | list }}"
    when: final_users | length > 0

  ########################################################
  # CLEAN OLD REPORT
  ########################################################

  - name: Remove old report
    run_once: true
    delegate_to: localhost
    become: false
    file:
      path: "{{ lookup('env','WORKSPACE') }}/enterprise_security_audit.html"
      state: absent

  ########################################################
  # GENERATE PROFESSIONAL HTML REPORT
  ########################################################

  - name: Generate Enterprise Security HTML Report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ lookup('env','WORKSPACE') }}/enterprise_security_audit.html"
      content: |
        <html>
        <head>
        <title>Enterprise Security & Compliance Audit</title>
        <style>
        body {font-family: Arial;}
        table {border-collapse: collapse; width: 100%; margin-bottom:20px;}
        th, td {border:1px solid #ccc; padding:8px;}
        th {background:#003366; color:white;}
        .alert {background-color:#ffcccc;}
        h2 {background:#003366; color:white; padding:10px;}
        </style>
        </head>
        <body>

        <h2>Enterprise Security & Compliance Audit Report</h2>

        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}

        <h3>Host: {{ sys.host }}</h3>

        <table>
        <tr><th colspan="2">System Overview</th></tr>
        <tr><td>Operating System</td><td>{{ sys.os }}</td></tr>
        <tr><td>Kernel</td><td>{{ sys.kernel }}</td></tr>
        <tr><td>Machine Type</td><td>{{ sys.machine_type }}</td></tr>
        <tr><td>CPU Cores</td><td>{{ sys.cpu }}</td></tr>
        <tr><td>RAM Usage</td>
            <td>{{ sys.ram_used }} MB / {{ sys.ram_total }} MB</td></tr>
        <tr><td>Uptime</td><td>{{ sys.uptime_days }} days</td></tr>
        <tr><td>Load Average (1m)</td><td>{{ sys.load_avg }}</td></tr>
        <tr><td>Last Patch Date</td><td>{{ sys.last_patch }}</td></tr>
        </table>

        <table>
        <tr><th>Mount</th><th>Size (GB)</th><th>Used %</th></tr>
        {% for disk in hostvars[host].disk_info %}
        <tr class="{% if disk.alert == 'YES' %}alert{% endif %}">
          <td>{{ disk.mount }}</td>
          <td>{{ disk.size }}</td>
          <td>{{ disk.used }}%</td>
        </tr>
        {% endfor %}
        </table>

        <table>
        <tr><th colspan="3">Sudo Users</th></tr>

        {% if hostvars[host].final_users | length == 0 %}
        <tr><td colspan="3">No sudo users found</td></tr>
        {% else %}
        <tr><th>User</th><th>Last Login</th><th>Password Policy</th></tr>
        {% for line in hostvars[host].report_data %}
        {% set cols = line.split('|') %}
        <tr>
          <td>{{ cols[0] }}</td>
          <td>{{ cols[1] }}</td>
          <td>{{ cols[2] }}</td>
        </tr>
        {% endfor %}
        {% endif %}
        </table>

        <hr>
        {% endfor %}

        </body>
        </html>
