---
- name: Full System + Sudo User Audit Report
  hosts: "{{ hosts.split(';') }}"
  become: yes
  gather_facts: yes

  vars:
    valid_users: []
    final_users: []
    report_data: []

  tasks:

  ########################################################
  # SYSTEM INFORMATION
  ########################################################

  - name: Collect hardware Make
    command: cat /sys/devices/virtual/dmi/id/sys_vendor
    register: sys_vendor
    changed_when: false
    ignore_errors: yes

  - name: Collect hardware Model
    command: cat /sys/devices/virtual/dmi/id/product_name
    register: sys_model
    changed_when: false
    ignore_errors: yes

  ########################################################
  # LAST PATCH DATE
  ########################################################

  - name: Get last patch date (RHEL-based)
    shell: rpm -qa --last | head -1 | awk '{print $3"-"$2"-"$6}'
    register: last_patch_rhel
    when: ansible_os_family == "RedHat"
    changed_when: false
    ignore_errors: yes

  - name: Get last patch date (Debian-based)
    shell: date -d "$(stat -c %y /var/log/apt/history.log 2>/dev/null)" +%Y-%m-%d
    register: last_patch_debian
    when: ansible_os_family == "Debian"
    changed_when: false
    ignore_errors: yes

  - name: Set last patch fact
    set_fact:
      last_patch: >-
        {{
          (last_patch_rhel.stdout if ansible_os_family == "RedHat" else
           last_patch_debian.stdout if ansible_os_family == "Debian" else
           "N/A") | default("N/A")
        }}

  ########################################################
  # MACHINE TYPE (BUILT-IN FACT)
  ########################################################

  - name: Set machine type
    set_fact:
      machine_type: "{{ ansible_virtualization_type | default('physical') }}"

  ########################################################
  # SET SYSTEM INFO FACT
  ########################################################

  - name: Set system info
    set_fact:
      system_info:
        host: "{{ inventory_hostname }}"
        os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
        kernel: "{{ ansible_kernel }}"
        cpu: "{{ ansible_processor_vcpus }}"
        ram: "{{ ansible_memtotal_mb }} MB"
        make: "{{ sys_vendor.stdout | default('N/A') }}"
        model: "{{ sys_model.stdout | default('N/A') }}"
        machine_type: "{{ machine_type }}"
        last_patch: "{{ last_patch }}"

  ########################################################
  # DISK INFO
  ########################################################

  - name: Build disk info list
    set_fact:
      disk_info: "{{ disk_info | default([]) + [ item.mount ~ ' (' ~ ((item.size_total/1024/1024/1024)|round(2)) ~ ' GB)' ] }}"
    loop: "{{ ansible_mounts }}"
    when:
      - item.fstype not in ['tmpfs','devtmpfs','overlay']
      - not item.mount.startswith('/run')

  ########################################################
  # USER FILTERING
  ########################################################

  - name: Get passwd entries
    getent:
      database: passwd

  - name: Get group entries
    getent:
      database: group

  - name: Build valid local users list (UID >=1000)
    set_fact:
      valid_users: "{{ valid_users + [ item.key ] }}"
    loop: "{{ getent_passwd | dict2items }}"
    when:
      - item.value[2] | int >= 1000
      - item.key != "nobody"

  - name: Build sudo group users list
    set_fact:
      sudo_group_users: >-
        {{
          (getent_group['sudo'][2].split(',') if 'sudo' in getent_group else []) +
          (getent_group['wheel'][2].split(',') if 'wheel' in getent_group else [])
        }}

  - name: Keep only sudo users
    set_fact:
      final_users: "{{ valid_users | intersect(sudo_group_users | default([])) }}"

  ########################################################
  # COLLECT USER DETAILS
  ########################################################

  - name: Collect user details
    shell: |
      LASTLOGIN=$(lastlog -u {{ item }} | tail -1 | awk '{$1=$2=$3=""; print $0}')
      GROUPS=$(id -nG {{ item }})
      PASSLAST=$(chage -l {{ item }} | grep "Last password change")
      PASSMAX=$(chage -l {{ item }} | grep "Maximum")
      echo "{{ inventory_hostname }}|{{ item }}|$LASTLOGIN|$GROUPS|$PASSLAST|$PASSMAX"
    loop: "{{ final_users }}"
    register: user_output
    changed_when: false

  - name: Store user report data
    set_fact:
      report_data: "{{ user_output.results | map(attribute='stdout') | list }}"

  ########################################################
  # CLEAN OLD REPORTS (JENKINS WORKSPACE)
  ########################################################

  - name: Remove old reports
    run_once: true
    delegate_to: localhost
    become: false
    file:
      path: "{{ lookup('env','WORKSPACE') }}/{{ item }}"
      state: absent
    loop:
      - system_report.txt
      - system_report.csv
      - system_report.html

  ########################################################
  # GENERATE TXT REPORT
  ########################################################

  - name: Generate TXT report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ lookup('env','WORKSPACE') }}/system_report.txt"
      content: |
        ================= FULL SYSTEM AUDIT REPORT =================

        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}
        ------------------------------------------------------------
        Host: {{ sys.host }}
        OS: {{ sys.os }}
        Kernel: {{ sys.kernel }}
        Machine Type: {{ sys.machine_type }}
        Last Patched: {{ sys.last_patch }}
        CPU Cores: {{ sys.cpu }}
        RAM: {{ sys.ram }}
        Make: {{ sys.make }}
        Model: {{ sys.model }}

        Filesystems:
        {% for disk in hostvars[host].disk_info | default([]) %}
          - {{ disk }}
        {% endfor %}

        SUDO USERS:
        {% for line in hostvars[host].report_data | default([]) %}
        {% set cols = line.split('|') %}
          User: {{ cols[1] }}
          Last Login: {{ cols[2] }}
          Groups: {{ cols[3] }}
          {{ cols[4] }}
          {{ cols[5] }}
        {% endfor %}

        ============================================================

        {% endfor %}

  ########################################################
  # GENERATE CSV REPORT
  ########################################################

  - name: Generate CSV report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ lookup('env','WORKSPACE') }}/system_report.csv"
      content: |
        Host,OS,Kernel,MachineType,LastPatched,CPU,RAM,Make,Model
        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}
        {{ sys.host }},{{ sys.os }},{{ sys.kernel }},{{ sys.machine_type }},{{ sys.last_patch }},{{ sys.cpu }},{{ sys.ram }},{{ sys.make }},{{ sys.model }}
        {% endfor %}

  ########################################################
  # GENERATE HTML REPORT
  ########################################################

  - name: Generate HTML report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ lookup('env','WORKSPACE') }}/system_report.html"
      content: |
        <html>
        <head>
        <title>Full System Audit Report</title>
        <style>
        table {border-collapse: collapse; width: 100%;}
        th, td {border:1px solid black; padding:8px;}
        th {background:#f2f2f2;}
        </style>
        </head>
        <body>
        <h2>Full System Audit Report</h2>

        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}
        <h3>{{ sys.host }}</h3>
        <ul>
          <li>OS: {{ sys.os }}</li>
          <li>Kernel: {{ sys.kernel }}</li>
          <li>Machine Type: {{ sys.machine_type }}</li>
          <li>Last Patched: {{ sys.last_patch }}</li>
          <li>CPU: {{ sys.cpu }}</li>
          <li>RAM: {{ sys.ram }}</li>
          <li>Make: {{ sys.make }}</li>
          <li>Model: {{ sys.model }}</li>
        </ul>

        <h4>Sudo Users</h4>
        <table>
        <tr>
          <th>User</th>
          <th>Last Login</th>
          <th>Groups</th>
          <th>Password Info</th>
        </tr>

        {% for line in hostvars[host].report_data | default([]) %}
        {% set cols = line.split('|') %}
        <tr>
          <td>{{ cols[1] }}</td>
          <td>{{ cols[2] }}</td>
          <td>{{ cols[3] }}</td>
          <td>{{ cols[4] }}<br>{{ cols[5] }}</td>
        </tr>
        {% endfor %}
        </table>
        <hr>
        {% endfor %}

        </body>
        </html>
