---
- name: Perform Maintenance Tasks
  hosts: "{{ hosts.split(';') }}"
  gather_facts: true

  tasks:
    - name: Gather system information
      block:
        - name: Get distribution name
          command: cat /etc/os-release
          register: distro_info
          failed_when: false

        - name: Get CPU information
          command: lscpu
          register: cpu_info
          failed_when: false

        - name: Get RAM information
          command: free -h
          register: ram_info
          failed_when: false

        - name: Get kernel version
          command: uname -r
          register: kernel_version
          failed_when: false

        - name: Get hardware type
          command: sudo dmidecode -s system-product-name
          register: hardware_type
          become: true
          failed_when: false

        - name: Aggregate information
          set_fact:
            system_info:
              hostname: "{{ inventory_hostname }}"
              distribution: "{{ distro_info.stdout | default('N/A') }}"
              cpu: "{{ cpu_info.stdout | default('N/A') }}"
              ram: "{{ ram_info.stdout | default('N/A') }}"
              kernel: "{{ kernel_version.stdout | default('N/A') }}"
              hardware: "{{ hardware_type.stdout | default('N/A') }}"

        - name: Collect all system information for display
          set_fact:
            all_systems_info: "{{ all_systems_info | default([]) + [system_info] }}"

    - name: Write report to CSV file
      copy:
        dest: /tmp/system_report.csv
        content: |
          hostname,distribution,cpu,ram,kernel,hardware
          {% for system in all_systems_info %}
          {{ system.hostname }},{{ system.distribution | replace(',', ' ') }},{{ system.cpu | replace(',', ' ') }},{{ system.ram | replace(',', ' ') }},{{ system.kernel }},{{ system.hardware | replace(',', ' ') }}
          {% endfor %}
