---
- name: Install Gradle 7.4.2 on Ubuntu
  hosts: "{{ hosts.split(';') }}"
  become: yes
  gather_facts: yes

  vars:
    gradle_version: "7.4.2"
    gradle_zip: "gradle-{{ gradle_version }}-bin.zip"
    gradle_url: "https://services.gradle.org/distributions/{{ gradle_zip }}"
    install_dir: "/usr/local"
    gradle_extract_dir: "{{ install_dir }}/gradle-{{ gradle_version }}"
    gradle_symlink: "{{ install_dir }}/gradle"
    gradle_bin_path: "{{ gradle_symlink }}/bin/gradle"

  tasks:

    - name: Install unzip
      apt:
        name: unzip
        state: present
        update_cache: yes

    - name: Check if Gradle binary exists
      stat:
        path: "{{ gradle_bin_path }}"
      register: gradle_file_check

    - name: Get installed Gradle version
      command: "{{ gradle_bin_path }} --version"
      register: gradle_installed_version
      failed_when: false
      changed_when: false
      when: gradle_file_check.stat.exists

    - name: Determine if installed Gradle version matches expected
      set_fact:
        gradle_version_matches: "{{ gradle_installed_version.stdout is search('Gradle ' + gradle_version) }}"
      when: gradle_file_check.stat.exists

    - name: Show installed Gradle version
      debug:
        msg: "Installed Gradle version: {{ gradle_installed_version.stdout }}"
      when: gradle_file_check.stat.exists

    - name: Skip installation if correct version installed
      debug:
        msg: "Gradle {{ gradle_version }} already installed. Skipping."
      when: gradle_file_check.stat.exists and gradle_version_matches

    - name: Download Gradle ZIP
      get_url:
        url: "{{ gradle_url }}"
        dest: "/tmp/{{ gradle_zip }}"
        mode: '0644'
      when: not gradle_file_check.stat.exists or not gradle_version_matches

    - name: Extract Gradle
      unarchive:
        src: "/tmp/{{ gradle_zip }}"
        dest: "{{ install_dir }}"
        remote_src: yes
        creates: "{{ gradle_extract_dir }}"
      when: not gradle_file_check.stat.exists or not gradle_version_matches

    - name: Create Gradle symlink
      file:
        src: "{{ gradle_extract_dir }}"
        dest: "{{ gradle_symlink }}"
        state: link
        force: yes
      when: not gradle_file_check.stat.exists or not gradle_version_matches

    - name: Check if /etc/environment.bak exists
      stat:
        path: /etc/environment.bak
      register: env_backup_check

    - name: Backup /etc/environment if not already backed up
      copy:
        src: /etc/environment
        dest: /etc/environment.bak
        remote_src: yes
      when: not env_backup_check.stat.exists

    # ---------------------------------------------------
    # APPEND GRADLE PATH (corrected)
    # ---------------------------------------------------
    - name: Check if Gradle path already in /etc/environment
      command: grep -q "/usr/local/gradle/bin" /etc/environment
      register: gradle_path_present
      failed_when: false
      changed_when: false

    - name: Append Gradle path to /etc/environment
      lineinfile:
        path: /etc/environment
        insertafter: EOF
        line: 'PATH="$PATH:/usr/local/gradle/bin"'
      when: gradle_path_present.rc != 0

    # ---------------------------------------------------
    # Optional backup of system gradle
    # ---------------------------------------------------
    - name: Backup system gradle if exists
      shell: mv /usr/bin/gradle /usr/bin/gradle_backup
      args:
        removes: /usr/bin/gradle
      ignore_errors: yes

    - name: Verify Gradle version after installation
      command: "{{ gradle_bin_path }} --version"
      register: final_gradle_version

    - name: Show final installed Gradle version
      debug:
        msg: "{{ final_gradle_version.stdout }}"

    - name: Which gradle is used
      command: which gradle
      register: which_gradle

    - name: Show gradle path
      debug:
        msg: "Gradle binary used: {{ which_gradle.stdout }}"
