---
- name: Install Java 21 and Gradle 7.4.2 on Ubuntu
  hosts: "{{ hosts.split(';') }}"
  become: yes
  gather_facts: yes

  vars:
    # -------------------------------
    # Java
    # -------------------------------
    java_major_version: "21"
    java_packages:
      - openjdk-21-jdk
      - openjdk-21-jre

    # -------------------------------
    # Gradle
    # -------------------------------
    gradle_version: "7.4.2"
    gradle_zip: "gradle-{{ gradle_version }}-bin.zip"
    gradle_url: "https://services.gradle.org/distributions/{{ gradle_zip }}"
    install_dir: "/usr/local"
    gradle_extract_dir: "{{ install_dir }}/gradle-{{ gradle_version }}"
    gradle_symlink: "{{ install_dir }}/gradle"
    gradle_bin_path: "{{ gradle_symlink }}/bin/gradle"

  tasks:

    # ===================================================
    # Java 21 check
    # ===================================================
    - name: Check if Java is installed
      command: java -version
      register: java_check
      failed_when: false
      changed_when: false

    - name: Detect installed Java major version
      set_fact:
        java_version_matches: "{{ java_check.stderr is regex_search('\"{{ java_major_version }}') }}"
      when: java_check.rc == 0

    - name: Show detected Java version
      debug:
        msg: "{{ java_check.stderr_lines }}"
      when: java_check.rc == 0

    # ===================================================
    # Install Java 21 if missing or wrong version
    # ===================================================
    - block:
        - name: Update apt cache
          apt:
            update_cache: yes

        - name: Install OpenJDK 21 JDK and JRE
          apt:
            name: "{{ java_packages }}"
            state: present

        - name: Verify Java installation
          command: java -version
          register: java_installed
          changed_when: false

        - name: Show installed Java version
          debug:
            msg: "{{ java_installed.stderr_lines }}"
      when: java_check.rc != 0 or not java_version_matches

    # ===================================================
    # Install unzip (required for Gradle)
    # ===================================================
    - name: Install unzip
      apt:
        name: unzip
        state: present

    # ===================================================
    # Gradle check
    # ===================================================
    - name: Check if Gradle binary exists
      stat:
        path: "{{ gradle_bin_path }}"
      register: gradle_file_check

    - name: Get installed Gradle version
      command: "{{ gradle_bin_path }} --version"
      register: gradle_installed_version
      failed_when: false
      changed_when: false
      when: gradle_file_check.stat.exists

    - name: Detect Gradle version match
      set_fact:
        gradle_version_matches: "{{ gradle_installed_version.stdout is regex_search('Gradle\\s+{{ gradle_version }}') }}"
      when: gradle_file_check.stat.exists

    - name: Show installed Gradle version
      debug:
        msg: "{{ gradle_installed_version.stdout_lines }}"
      when: gradle_file_check.stat.exists

    # ===================================================
    # Install / Upgrade Gradle if needed
    # ===================================================
    - block:
        - name: Download Gradle ZIP
          get_url:
            url: "{{ gradle_url }}"
            dest: "/tmp/{{ gradle_zip }}"
            mode: '0644'

        - name: Extract Gradle
          unarchive:
            src: "/tmp/{{ gradle_zip }}"
            dest: "{{ install_dir }}"
            remote_src: yes

        - name: Create Gradle symlink
          file:
            src: "{{ gradle_extract_dir }}"
            dest: "{{ gradle_symlink }}"
            state: link
            force: yes
      when: not gradle_file_check.stat.exists or not gradle_version_matches

    # ===================================================
    # Add Gradle to PATH (system-wide)
    # ===================================================
    - name: Configure Gradle environment variables
      copy:
        dest: /etc/profile.d/gradle.sh
        mode: '0644'
        content: |
          export GRADLE_HOME={{ gradle_symlink }}
          export PATH=$PATH:$GRADLE_HOME/bin

    # ===================================================
    # Final verification
    # ===================================================
    - name: Show Gradle version using absolute path
      command: "{{ gradle_bin_path }} --version"
      register: final_gradle_version
      changed_when: false

    - name: Display Gradle version
      debug:
        msg: "{{ final_gradle_version.stdout_lines }}"

    - name: Check Gradle via PATH
      command: gradle --version
      register: gradle_via_path
      failed_when: false
      changed_when: false

    - name: Display Gradle version via PATH
      debug:
        msg: "{{ gradle_via_path.stdout_lines }}"
