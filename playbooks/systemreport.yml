---
- name: Full Enterprise System Audit
  hosts: "{{ target_hosts.split(',') }}"
  gather_facts: yes
  become: yes

  vars:
    valid_users: []
    final_users: []
    report_data: []

  tasks:

  ########################################################
  # SYSTEM INFORMATION
  ########################################################

  - name: Get last patch date (Debian/Ubuntu)
    shell: "stat -c %y /var/lib/dpkg/status 2>/dev/null | awk '{print $1}' || echo 'N/A'"
    register: last_patch
    changed_when: false

  - name: Get last patch date (RHEL/SLES)
    shell: "rpm -q --last 2>/dev/null | head -1 | awk '{print $1}' || echo 'N/A'"
    when: ansible_os_family in ['RedHat', 'Suse']
    register: last_patch_rpm
    changed_when: false

  - name: Set last patch universally
    set_fact:
      last_patch_final: "{{ last_patch_rpm.stdout if ansible_os_family in ['RedHat','Suse'] else last_patch.stdout | default('N/A') }}"

  - name: Get full kernel version
    shell: uname -rv
    register: kernel_full
    changed_when: false

  - name: Get used RAM safely
    shell: free -m | awk '/Mem:/ {print $3}'
    register: ram_used_cmd
    changed_when: false

  - name: Set system info
    set_fact:
      system_info:
        host: "{{ inventory_hostname }}"
        os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
        kernel: "{{ kernel_full.stdout | default(ansible_kernel) }}"
        cpu: "{{ ansible_processor_vcpus | default(ansible_processor_count | default('N/A')) }}"
        ram_total: "{{ ansible_memtotal_mb | default('N/A') }} MB"
        ram_used: "{{ ram_used_cmd.stdout }} MB"
        uptime_days: "{{ (ansible_uptime_seconds | int // 86400) }}"
        last_patch: "{{ last_patch_final }}"

  ########################################################
  # USER ENUMERATION
  ########################################################

  - name: Read /etc/passwd
    slurp:
      src: /etc/passwd
    register: passwd_file
    changed_when: false

  - name: Parse passwd entries
    set_fact:
      getent_passwd: "{{ getent_passwd | default({}) | combine({ item.0: {'uid': item.2, 'gid': item.3, 'home': item.5, 'shell': item.6} }) }}"
    loop: "{{ passwd_file.content | b64decode | split('\n') | reject('equalto','') | map('split', ':') | list }}"

  - name: Build valid local login users list
    set_fact:
      valid_users: >-
        {{
          getent_passwd
          | dict2items
          | selectattr('value.shell','defined')
          | rejectattr('value.shell','in',['/usr/sbin/nologin','/sbin/nologin','/bin/false','/usr/bin/false'])
          | map(attribute='key')
          | reject('equalto','nobody')
          | list
        }}

  - name: Remove root from sudo check
    set_fact:
      valid_users: "{{ valid_users | difference(['root']) }}"

  ########################################################
  # SUDO DETECTION
  ########################################################

  - name: Detect real sudo users
    shell: |
      sudo -l -U {{ item }} 2>/dev/null | grep -q 'ALL' && echo {{ item }} || echo ""
    loop: "{{ valid_users }}"
    register: sudo_check
    changed_when: false
    ignore_errors: yes

  - name: Build final sudo users list
    set_fact:
      final_users: "{{ (sudo_check.results | map(attribute='stdout') | reject('equalto','') | list) + ['root'] }}"

  ########################################################
  # USER DETAILS (FIXED LAST LOGIN)
  ########################################################

  - name: Collect sudo user details
    shell: |
      LOGIN_LINE=$(lastlog -u {{ item }} | tail -1)
      if echo "$LOGIN_LINE" | grep -q "Never"; then
        LASTLOGIN="Never"
      else
        LASTLOGIN=$(echo "$LOGIN_LINE" | cut -c 38-)
      fi
      GROUPS=$(id -nG {{ item }})
      echo "{{ inventory_hostname }}|{{ item }}|$LASTLOGIN|$GROUPS"
    loop: "{{ final_users }}"
    register: user_output
    changed_when: false
    ignore_errors: yes

  - name: Store user report data
    set_fact:
      report_data: "{{ user_output.results | map(attribute='stdout') | list }}"

  ########################################################
  # SECURITY CHECKS
  ########################################################

  - name: Check SSH root login
    shell: grep -Ei '^PermitRootLogin' /etc/ssh/sshd_config 2>/dev/null || echo "Not Set"
    register: ssh_root
    changed_when: false

  - name: Scan world writable files
    shell: find / -xdev -type f -perm -0002 2>/dev/null | wc -l
    register: world_writable_count
    changed_when: false

  - name: Scan SUID/SGID files
    shell: find / -xdev -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null | wc -l
    register: suid_count
    changed_when: false

  - name: Calculate security score
    set_fact:
      security_score: >-
        {{
          100
          - (10 if ssh_root.stdout is search("yes") else 0)
          - (10 if world_writable_count.stdout|int > 20 else 0)
          - (10 if suid_count.stdout|int > 50 else 0)
        }}

  - name: Assign risk rating
    set_fact:
      risk_rating: >-
        {% if security_score >= 90 %}
          LOW
        {% elif security_score >= 70 %}
          MEDIUM
        {% else %}
          HIGH
        {% endif %}

  ########################################################
  # CLEAN OLD REPORTS
  ########################################################

  - name: Remove old reports
    run_once: true
    delegate_to: localhost
    become: false
    file:
      path: "{{ lookup('env','WORKSPACE') }}/system_report.txt"
      state: absent

  - name: Remove old CSV
    run_once: true
    delegate_to: localhost
    become: false
    file:
      path: "{{ lookup('env','WORKSPACE') }}/system_report.csv"
      state: absent

  - name: Remove old HTML
    run_once: true
    delegate_to: localhost
    become: false
    file:
      path: "{{ lookup('env','WORKSPACE') }}/enterprise_system_report.html"
      state: absent

  ########################################################
  # GENERATE TXT REPORT
  ########################################################

  - name: Generate TXT report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ lookup('env','WORKSPACE') }}/system_report.txt"
      content: |
        ================= FULL SYSTEM AUDIT REPORT =================

        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}
        ------------------------------------------------------------
        Host: {{ sys.host }}
        OS: {{ sys.os }}
        Kernel: {{ sys.kernel }}
        CPU Cores: {{ sys.cpu }}
        RAM Total: {{ sys.ram_total }}
        RAM Used: {{ sys.ram_used }}
        Uptime (days): {{ sys.uptime_days }}
        Last Patch: {{ sys.last_patch }}
        Security Score: {{ hostvars[host].security_score }}/100 ({{ hostvars[host].risk_rating }})

        SUDO USERS:
        {% for line in hostvars[host].report_data | default([]) %}
        {% set cols = line.split('|') %}
        User: {{ cols[1] }}
        {% endfor %}

        LOGIN HISTORY:
        {% for line in hostvars[host].report_data | default([]) %}
        {% set cols = line.split('|') %}
        User {{ cols[1] }}: Last Login: {{ cols[2] }}
        {% endfor %}

        ============================================================

        {% endfor %}

  ########################################################
  # GENERATE CSV REPORT
  ########################################################

  - name: Generate CSV report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ lookup('env','WORKSPACE') }}/system_report.csv"
      content: |
        Host,OS,Kernel,CPU,RAM_Total,RAM_Used,Uptime_days,Last_Patch,Sudo_Users,Security_Score,Risk
        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}
        {% set sudo_users = hostvars[host].report_data | map('split','|') | map(attribute=1) | join(';') %}
        {{ sys.host }},{{ sys.os }},{{ sys.kernel }},{{ sys.cpu }},{{ sys.ram_total }},{{ sys.ram_used }},{{ sys.uptime_days }},{{ sys.last_patch }},{{ sudo_users }},{{ hostvars[host].security_score }},{{ hostvars[host].risk_rating }}
        {% endfor %}

  ########################################################
  # GENERATE HTML REPORT
  ########################################################

  - name: Generate HTML report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ lookup('env','WORKSPACE') }}/enterprise_system_report.html"
      content: |
        <html>
        <head>
        <title>Enterprise System Audit Report</title>
        <style>
        table {border-collapse: collapse; width:100%;}
        th, td {border:1px solid black; padding:6px;}
        th {background:#f2f2f2;}
        </style>
        </head>
        <body>
        <h2>Enterprise System Audit Report</h2>

        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}
        <h3>{{ sys.host }}</h3>
        <ul>
          <li>OS: {{ sys.os }}</li>
          <li>Kernel: {{ sys.kernel }}</li>
          <li>CPU: {{ sys.cpu }}</li>
          <li>RAM Total: {{ sys.ram_total }}</li>
          <li>RAM Used: {{ sys.ram_used }}</li>
          <li>Uptime (days): {{ sys.uptime_days }}</li>
          <li>Last Patch: {{ sys.last_patch }}</li>
          <li>Security Score: {{ hostvars[host].security_score }}/100 ({{ hostvars[host].risk_rating }})</li>
        </ul>

        <h4>Sudo Users</h4>
        <ul>
        {% for line in hostvars[host].report_data | default([]) %}
        {% set cols = line.split('|') %}
        <li>{{ cols[1] }} (Last Login: {{ cols[2] }})</li>
        {% endfor %}
        </ul>
        <hr>
        {% endfor %}
        </body>
        </html>
