---
- name: Enterprise Full Linux Audit Report - Production
  hosts: "{{ hosts.split(';') }}"
  gather_facts: yes
  become: yes

  vars:
    report_data: []

  tasks:

  ########################################################
  # SYSTEM INFORMATION
  ########################################################

  - name: Get last patch date
    shell: |
      if [ -f /var/lib/dpkg/status ]; then
        stat -c %y /var/lib/dpkg/status
      elif [ -f /var/lib/rpm/Packages ]; then
        stat -c %y /var/lib/rpm/Packages
      else
        echo "N/A"
      fi
    register: last_patch
    changed_when: false

  - name: Get RAM usage
    shell: |
      free -m | awk 'NR==2 {print $2 "|" $3}'
    register: ram_info
    changed_when: false

  - name: Set system info
    set_fact:
      system_info:
        host: "{{ inventory_hostname }}"
        os: "{{ ansible_distribution | default('N/A') }} {{ ansible_distribution_version | default('') }}"
        kernel: "{{ ansible_kernel | default('N/A') }}"
        machine_type: "{{ ansible_virtualization_type | default('physical') }}"
        cpu: "{{ ansible_processor_vcpus | default(ansible_processor_count | default('N/A')) }}"
        ram_total: "{{ (ram_info.stdout.split('|')[0] if '|' in ram_info.stdout else 'N/A') }} MB"
        ram_used: "{{ (ram_info.stdout.split('|')[1] if '|' in ram_info.stdout else 'N/A') }} MB"
        uptime_days: "{{ (ansible_uptime_seconds | default(0) | int) // 86400 }}"
        last_patch: "{{ last_patch.stdout | default('N/A') }}"

  ########################################################
  # DISK INFORMATION
  ########################################################

  - name: Build disk info list
    set_fact:
      disk_info: "{{ disk_info | default([]) + [ item.mount ~ ' (' ~ ((item.size_total/1024/1024/1024)|round(2)) ~ ' GB, ' ~ (item.percent | default('N/A')) ~ '%)' ] }}"
    loop: "{{ ansible_mounts | default([]) }}"
    when:
      - item.fstype not in ['tmpfs','devtmpfs','overlay']
      - not item.mount.startswith('/run')

  ########################################################
  # SUDO DETECTION (HYBRID - DIRECT + GROUP)
  ########################################################

  - name: Extract direct sudo user entries (exclude groups)
    shell: |
      awk '
        /^[^#]/ && $1 !~ /^%/ {
          print $1
        }
      ' /etc/sudoers /etc/sudoers.d/* 2>/dev/null
    register: direct_sudo
    changed_when: false
    ignore_errors: yes

  - name: Extract sudo groups from sudoers
    shell: |
      awk '
        /^[^#]/ && $1 ~ /^%/ {
          gsub("^%","",$1);
          print $1
        }
      ' /etc/sudoers /etc/sudoers.d/* 2>/dev/null
    register: sudo_groups
    changed_when: false
    ignore_errors: yes

  - name: Get group members for detected sudo groups
    shell: |
      for grp in {{ sudo_groups.stdout_lines | default([]) | join(' ') }}; do
        getent group "$grp" | awk -F: '{print $4}'
      done
    register: group_members_raw
    changed_when: false
    ignore_errors: yes

  - name: Normalize group members
    set_fact:
      group_sudo_users: >-
        {{
          (group_members_raw.stdout.split(',') if group_members_raw.stdout else [])
          | map('trim')
          | reject('equalto','')
          | list
        }}

  - name: Build final sudo user list
    set_fact:
      final_users: >-
        {{
          (
            (direct_sudo.stdout_lines | default([])) +
            (group_sudo_users | default([]))
          )
          | map('trim')
          | reject('equalto','')
          | unique
          | list
        }}

  ########################################################
  # COLLECT SUDO USER DETAILS
  ########################################################

  - name: Collect detailed sudo user information
    shell: |
      USERNAME="{{ item }}"
      if grep -E "^[^#]*\b${USERNAME}\b.*NOPASSWD" /etc/sudoers /etc/sudoers.d/* 2>/dev/null | grep -v '^%'; then
        SUDOTYPE="NOPASSWD"
      else
        SUDOTYPE="PASSWORD_REQUIRED"
      fi
      LASTLOGIN=$(lastlog -u "$USERNAME" 2>/dev/null | tail -1 | awk '{$1=$2=$3=""; print $0}')
      GROUPS=$(id -nG "$USERNAME" 2>/dev/null)
      PASSINFO=$(chage -l "$USERNAME" 2>/dev/null | grep "Last password change")
      echo "{{ inventory_hostname }}|$USERNAME|$SUDOTYPE|$LASTLOGIN|$GROUPS|$PASSINFO"
    loop: "{{ final_users }}"
    register: user_output
    changed_when: false
    ignore_errors: yes

  - name: Store report data
    set_fact:
      report_data: "{{ user_output.results | map(attribute='stdout') | reject('equalto','') | list }}"

  ########################################################
  # CLEAN OLD REPORT
  ########################################################

  - name: Remove old TXT report
    run_once: true
    delegate_to: localhost
    become: false
    file:
      path: "{{ lookup('env','WORKSPACE') | default('./') }}/enterprise_system_report.txt"
      state: absent

  ########################################################
  # GENERATE REPORT
  ########################################################

  - name: Generate TXT report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ lookup('env','WORKSPACE') | default('./') }}/enterprise_system_report.txt"
      content: |
        ================= FULL SYSTEM AUDIT REPORT =================

        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}

        ------------------------------------------------------------
        Host: {{ sys.host }}
        OS: {{ sys.os }}
        Kernel: {{ sys.kernel }}
        Machine Type: {{ sys.machine_type }}
        CPU Cores: {{ sys.cpu }}
        RAM Total: {{ sys.ram_total }}
        RAM Used: {{ sys.ram_used }}
        Uptime (days): {{ sys.uptime_days }}
        Last Patch: {{ sys.last_patch }}

        Filesystems:
        {% for disk in hostvars[host].disk_info | default([]) %}
          - {{ disk }}
        {% endfor %}

        SUDO USERS:
        {% if hostvars[host].report_data | length == 0 %}
          No sudo users found
        {% else %}
        {% for line in hostvars[host].report_data %}
        {% set cols = line.split('|') %}
          User: {{ cols[1] }}
          Sudo Type: {{ cols[2] }}
          Last Login: {{ cols[3] }}
          Groups: {{ cols[4] }}
          {{ cols[5] }}
          ----------------------------------------------------
        {% endfor %}
        {% endif %}

        ============================================================

        {% endfor %}
