---
- name: Full System + Sudo User Enterprise Audit Report
  hosts: "{{ hosts.split(',') }}"
  gather_facts: yes
  become: yes

  vars:
    valid_users: []
    sudo_users_raw: []
    final_users: []
    report_data: []

  tasks:

  ########################################################
  # SYSTEM INFORMATION
  ########################################################
  - name: Get last patch date
    shell: |
      if [ -f /var/lib/dpkg/status ]; then
        stat -c %y /var/lib/dpkg/status | awk '{print $1}'
      elif [ -f /var/lib/rpm/Packages ]; then
        rpm -qa --last | head -1 | awk '{print $NF}'
      else
        echo "N/A"
      fi
    register: last_patch
    changed_when: false

  - name: Set system info safely
    set_fact:
      system_info:
        host: "{{ inventory_hostname }}"
        os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
        kernel: "{{ ansible_kernel }}"
        machine_type: "{{ ansible_virtualization_type | default('physical') }}"
        cpu: "{{ ansible_processor_vcpus | default(ansible_processor_count | default('N/A')) }}"
        ram_total: "{{ ansible_memtotal_mb | default('N/A') }} MB"
        ram_used: >-
          {% if ansible_memavailable_mb is defined %}
            {{ ansible_memtotal_mb - ansible_memavailable_mb }} MB
          {% else %}
            N/A
          {% endif %}
        uptime_days: "{{ (ansible_uptime_seconds | default(0) // 86400) }}"
        last_patch: "{{ last_patch.stdout }}"

  ########################################################
  # DISK INFO
  ########################################################
  - name: Build disk info list
    set_fact:
      disk_info: "{{ disk_info | default([]) + [ item.mount ~ ' (' ~ ((item.size_total/1024/1024/1024)|round(2)) ~ ' GB, ' ~ (item.percent | default('N/A')) ~ ')' ] }}"
    loop: "{{ ansible_mounts }}"
    when:
      - item.fstype not in ['tmpfs','devtmpfs','overlay']
      - not item.mount.startswith('/run')

  ########################################################
  # USER FILTERING
  ########################################################
  - name: Read /etc/passwd
    slurp:
      src: /etc/passwd
    register: passwd_file
    changed_when: false

  - name: Parse passwd entries
    set_fact:
      getent_passwd: "{{ getent_passwd | default({}) | combine({ item.0: {'uid': item.2|int, 'gid': item.3|int, 'home': item.5, 'shell': item.6} }) }}"
    loop: "{{ passwd_file.content | b64decode | split('\n') | reject('equalto','') | map('split', ':') | list }}"

  - name: Build valid users list
    set_fact:
      valid_users: "{{ getent_passwd.keys() | list }}"

  ########################################################
  # SUDO USERS
  ########################################################
  - name: Collect all sudo users from /etc/sudoers and /etc/sudoers.d
    shell: "grep -hEv '^#|^$' /etc/sudoers /etc/sudoers.d/* 2>/dev/null | awk '{print $1}' || true"
    register: sudo_users_raw
    changed_when: false

  - name: Filter sudo users against local users
    set_fact:
      final_users: "{{ sudo_users_raw.stdout_lines | select('in', valid_users) | list }}"

  ########################################################
  # COLLECT USER DETAILS
  ########################################################
  - name: Collect sudo user details
    shell: |
      LASTLOGIN=$(lastlog -u {{ item }} | tail -1 | awk '{$1=$2=$3=""; print $0}')
      echo "{{ item }}|{{ LASTLOGIN | default('N/A') }}"
    loop: "{{ final_users }}"
    register: user_output
    changed_when: false
    ignore_errors: yes

  - name: Store user report data
    set_fact:
      report_data: "{{ user_output.results | map(attribute='stdout') | list }}"

  ########################################################
  # CLEAN OLD REPORTS
  ########################################################
  - name: Remove old TXT report
    run_once: true
    delegate_to: localhost
    become: false
    file:
      path: "{{ lookup('env','WORKSPACE') }}/system_report.txt"
      state: absent

  - name: Remove old CSV report
    run_once: true
    delegate_to: localhost
    become: false
    file:
      path: "{{ lookup('env','WORKSPACE') }}/system_report.csv"
      state: absent

  - name: Remove old HTML report
    run_once: true
    delegate_to: localhost
    become: false
    file:
      path: "{{ lookup('env','WORKSPACE') }}/enterprise_system_report.html"
      state: absent

  ########################################################
  # GENERATE TXT REPORT
  ########################################################
  - name: Generate TXT report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ lookup('env','WORKSPACE') }}/system_report.txt"
      content: |
        ================= FULL SYSTEM AUDIT REPORT =================

        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}
        ------------------------------------------------------------
        Host: {{ sys.host }}
        OS: {{ sys.os }}
        Kernel: {{ sys.kernel }}
        Machine Type: {{ sys.machine_type }}
        CPU Cores: {{ sys.cpu }}
        RAM Total: {{ sys.ram_total }}
        RAM Used: {{ sys.ram_used }}
        Uptime (days): {{ sys.uptime_days }}
        Last Patch: {{ sys.last_patch }}

        SUDO USERS:
        {% for line in hostvars[host].report_data %}
        {% set cols = line.split('|') %}
        User: {{ cols[0] }}
        Last Login: {{ cols[1] }}
        {% endfor %}

        ============================================================

        {% endfor %}

  ########################################################
  # GENERATE CSV REPORT
  ########################################################
  - name: Generate CSV report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ lookup('env','WORKSPACE') }}/system_report.csv"
      content: |
        Host,Sudo_Users,Login_History
        {% for host in ansible_play_hosts %}
        {% set sudo_list = hostvars[host].report_data | map('split','|') | map('first') | join('; ') %}
        {% set login_list = hostvars[host].report_data | map('split','|') | map('last') | join('; ') %}
        {{ host }},"{{ sudo_list }}","{{ login_list }}"
        {% endfor %}

  ########################################################
  # GENERATE HTML REPORT
  ########################################################
  - name: Generate HTML report
    run_once: true
    delegate_to: localhost
    become: false
    copy:
      dest: "{{ lookup('env','WORKSPACE') }}/enterprise_system_report.html"
      content: |
        <html>
        <head>
        <title>Full System Audit Report</title>
        <style>
        table {border-collapse: collapse; width: 100%;}
        th, td {border:1px solid black; padding:8px;}
        th {background:#f2f2f2;}
        </style>
        </head>
        <body>
        <h2>Full System Audit Report</h2>

        {% for host in ansible_play_hosts %}
        {% set sys = hostvars[host].system_info %}
        <h3>{{ sys.host }}</h3>
        <ul>
          <li>OS: {{ sys.os }}</li>
          <li>Kernel: {{ sys.kernel }}</li>
          <li>Machine Type: {{ sys.machine_type }}</li>
          <li>CPU Cores: {{ sys.cpu }}</li>
          <li>RAM Total: {{ sys.ram_total }}</li>
          <li>RAM Used: {{ sys.ram_used }}</li>
          <li>Uptime (days): {{ sys.uptime_days }}</li>
          <li>Last Patch: {{ sys.last_patch }}</li>
        </ul>

        <h4>Sudo Users</h4>
        <table>
        <tr><th>User</th><th>Last Login</th></tr>
        {% for line in hostvars[host].report_data %}
        {% set cols = line.split('|') %}
        <tr>
          <td>{{ cols[0] }}</td>
          <td>{{ cols[1] }}</td>
        </tr>
        {% endfor %}
        </table>
        <hr>
        {% endfor %}

        </body>
        </html>
