---
- name: Full Enterprise System Audit (v4 Hardened)
  hosts: "{{ target_hosts.split(',') }}"
  gather_facts: yes
  become: yes

  vars:
    valid_users: []
    final_users: []
    report_data: []

  tasks:

  ########################################################
  # DEBUG VERSION
  ########################################################

  - name: DEBUG PLAYBOOK VERSION
    debug:
      msg: "AUDIT PLAYBOOK VERSION 4 - CI SAFE"

  ########################################################
  # PATCH STATUS - DEBIAN / UBUNTU
  ########################################################

  - name: Get last apt upgrade date
    shell: |
      grep -i "Start-Date" /var/log/apt/history.log 2>/dev/null | tail -1 | awk '{print $2}'
    when: ansible_os_family == "Debian"
    register: last_patch_deb
    changed_when: false
    failed_when: false

  - name: Count pending upgrades (Debian)
    shell: |
      apt list --upgradable 2>/dev/null | grep -v "Listing" | wc -l
    when: ansible_os_family == "Debian"
    register: pending_updates_deb
    changed_when: false
    failed_when: false

  - name: Check reboot required (Debian)
    stat:
      path: /var/run/reboot-required
    when: ansible_os_family == "Debian"
    register: reboot_required_deb

  - name: Get latest installed kernel (Debian)
    shell: |
      dpkg -l | awk '/linux-image-[0-9]/{print $2}' | sort -V | tail -1 | sed 's/linux-image-//'
    when: ansible_os_family == "Debian"
    register: latest_kernel_deb
    changed_when: false
    failed_when: false

  ########################################################
  # PATCH STATUS - RHEL / SUSE
  ########################################################

  - name: Get last RPM package install date
    shell: |
      rpm -q --last | head -1
    when: ansible_os_family in ['RedHat','Suse']
    register: last_patch_rpm
    changed_when: false
    failed_when: false

  - name: Count pending updates (RHEL/SUSE)
    shell: |
      if command -v dnf >/dev/null 2>&1; then
        dnf check-update -q | wc -l
      else
        yum check-update -q | wc -l
      fi
    when: ansible_os_family in ['RedHat','Suse']
    register: pending_updates_rpm
    changed_when: false
    failed_when: false

  ########################################################
  # UNIVERSAL PATCH FACTS
  ########################################################

  - name: Get running kernel
    command: uname -r
    register: running_kernel
    changed_when: false

  - name: Set unified patch facts
    set_fact:
      last_patch_final: >-
        {{
          (last_patch_deb.stdout if ansible_os_family == "Debian"
          else last_patch_rpm.stdout) | default("N/A")
        }}
      pending_update_count: >-
        {{
          (pending_updates_deb.stdout if ansible_os_family == "Debian"
          else pending_updates_rpm.stdout) | default("0")
        }}
      reboot_required: >-
        {{
          (reboot_required_deb.stat.exists if ansible_os_family == "Debian"
          else false) | default(false)
        }}
      latest_kernel: >-
        {{
          (latest_kernel_deb.stdout if ansible_os_family == "Debian"
          else running_kernel.stdout) | default(running_kernel.stdout)
        }}
      kernel_mismatch: "{{ running_kernel.stdout != latest_kernel }}"

  ########################################################
  # SYSTEM INFO
  ########################################################

  - name: Get used RAM
    shell: |
      free -m | awk '/Mem:/ {print $3}'
    register: ram_used_cmd
    changed_when: false

  - name: Set system info
    set_fact:
      system_info:
        host: "{{ inventory_hostname }}"
        os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
        kernel_running: "{{ running_kernel.stdout }}"
        kernel_latest: "{{ latest_kernel }}"
        kernel_mismatch: "{{ kernel_mismatch }}"
        cpu: "{{ ansible_processor_vcpus | default(ansible_processor_count | default('N/A')) }}"
        ram_total: "{{ ansible_memtotal_mb }} MB"
        ram_used: "{{ ram_used_cmd.stdout | default('N/A') }} MB"
        uptime_days: "{{ (ansible_uptime_seconds | int // 86400) }}"
        last_patch: "{{ last_patch_final }}"
        pending_updates: "{{ pending_update_count }}"
        reboot_required: "{{ reboot_required }}"

  ########################################################
  # USER ENUMERATION (FIXED YAML SAFE)
  ########################################################

  - name: Get local login users
    shell: |
      awk -F: '$3 >= 1000 && $7 !~ /(nologin|false)/ {print $1}' /etc/passwd
    register: valid_users_cmd
    changed_when: false
    failed_when: false

  - name: Set valid users
    set_fact:
      valid_users: "{{ valid_users_cmd.stdout_lines | default([]) | difference(['nobody']) }}"

  - name: Detect sudo users
    shell: |
      sudo -l -U {{ item }} 2>/dev/null | grep -q 'ALL' && echo {{ item }}
    loop: "{{ valid_users }}"
    register: sudo_check
    changed_when: false
    ignore_errors: yes

  - name: Build final sudo users list
    set_fact:
      final_users: "{{ (sudo_check.results | map(attribute='stdout') | reject('equalto','') | list) + ['root'] }}"

  ########################################################
  # USER DETAILS
  ########################################################

  - name: Collect sudo user details
    shell: |
      LAST=$(lastlog -u {{ item }} | tail -1 | awk '{$1=$2=$3=""; print $0}' | xargs)
      GROUPS=$(id -nG {{ item }})
      echo "{{ inventory_hostname }}|{{ item }}|${LAST:-Never}|$GROUPS"
    loop: "{{ final_users }}"
    register: user_output
    changed_when: false
    failed_when: false

  - name: Store user report data
    set_fact:
      report_data: "{{ user_output.results | map(attribute='stdout') | list }}"

  ########################################################
  # SECURITY CHECKS
  ########################################################

  - name: Check SSH root login
    shell: |
      grep -Ei '^PermitRootLogin' /etc/ssh/sshd_config 2>/dev/null || echo "Not Set"
    register: ssh_root
    changed_when: false

  - name: Count world writable files
    shell: |
      find / -xdev -type f -perm -0002 2>/dev/null | wc -l
    register: world_writable_count
    changed_when: false

  - name: Count SUID/SGID files
    shell: |
      find / -xdev -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null | wc -l
    register: suid_count
    changed_when: false

  - name: Calculate security score
    set_fact:
      security_score: >-
        {{
          100
          - (20 if pending_update_count|int > 0 else 0)
          - (15 if reboot_required else 0)
          - (10 if ssh_root.stdout is search("yes") else 0)
          - (10 if world_writable_count.stdout|int > 20 else 0)
          - (10 if suid_count.stdout|int > 50 else 0)
        }}

  - name: Assign risk rating
    set_fact:
      risk_rating: >-
        {% if security_score >= 85 %}
        LOW
        {% elif security_score >= 60 %}
        MEDIUM
        {% else %}
        HIGH
        {% endif %}
