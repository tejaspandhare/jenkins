########################################################
# USER DETAILS (FIXED LAST LOGIN - ISO FORMAT)
########################################################

- name: Collect sudo user details (fixed last login ISO format)
  shell: |
    # Get last login line for the user
    LOGIN_LINE=$(lastlog -u {{ item }} | tail -1)

    # Parse last login
    if echo "$LOGIN_LINE" | grep -q "\*\*Never"; then
      LASTLOGIN="Never"
    else
      # Extract date and time columns from lastlog and convert to ISO format
      RAW_DATE=$(echo "$LOGIN_LINE" | awk '{for(i=4;i<=NF;i++) printf $i" "; print ""}')
      # Convert to YYYY-MM-DD HH:MM:SS using date command
      LASTLOGIN=$(date -d "$RAW_DATE" +"%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "$RAW_DATE")
    fi

    # Get groups
    GROUPS=$(id -nG {{ item }})

    # Output in inventory_host|user|lastlogin|groups format
    echo "{{ inventory_hostname }}|{{ item }}|$LASTLOGIN|$GROUPS"
  loop: "{{ final_users }}"
  register: user_output
  changed_when: false
  ignore_errors: yes

- name: Store user report data
  set_fact:
    report_data: "{{ user_output.results | map(attribute='stdout') | list }}"
