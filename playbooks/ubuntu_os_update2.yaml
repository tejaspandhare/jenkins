---
- name: Perform Maintenance Tasks
  hosts: "{{ hosts.split(';') }}"
  gather_facts: true
  become: true

  vars:
    EXCLUDE_PKGS: "{{ lookup('env', 'EXCLUDE_PKGS') | default('') }}"
    exclude_packages_list: "{{ EXCLUDE_PKGS.split(';') | map('trim') | reject('equalto','') | list }}"

  tasks:

    #################################################################
    # Remove Disabled Snaps
    #################################################################

    - name: Get list of disabled snaps
      ansible.builtin.shell: snap list --all | awk '/disabled/{print $1, $3}'
      register: disabled_snaps
      changed_when: false

    - name: Remove disabled snap revisions
      ansible.builtin.shell: snap remove {{ item.split()[0] }} --revision={{ item.split()[1] }}
      loop: "{{ disabled_snaps.stdout_lines }}"
      when: disabled_snaps.stdout_lines | length > 0
      ignore_errors: true

    #################################################################
    # System Cleanup
    #################################################################

    - name: Vacuum journal logs to 20M
      ansible.builtin.shell: journalctl --vacuum-size=20M
      changed_when: false

    - name: Fix broken packages
      ansible.builtin.shell: DEBIAN_FRONTEND=noninteractive dpkg --configure -a
      changed_when: false

    #################################################################
    # APT Update
    #################################################################

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

    - name: Check running kernel version before patching
      ansible.builtin.command: uname -r
      register: kernel_version_before
      changed_when: false

    #################################################################
    # Hold Excluded Packages
    #################################################################

    - name: Hold specified packages
      ansible.builtin.command: apt-mark hold {{ item }}
      loop: "{{ exclude_packages_list }}"
      when: exclude_packages_list | length > 0
      ignore_errors: true

    #################################################################
    # Perform Upgrade
    #################################################################

    - name: Perform dist upgrade
      ansible.builtin.apt:
        upgrade: dist
      register: apt_upgrade_result

    #################################################################
    # Kernel Detection
    #################################################################

    - name: Get latest installed kernel version
      ansible.builtin.shell: |
        dpkg -l 'linux-image-*' | awk '/^ii/{print $2}' | sort -V | tail -n1 | sed 's/linux-image-//'
      register: latest_kernel_install
      changed_when: false

    - name: Determine if reboot is required
      set_fact:
        reboot_required: "{{ latest_kernel_install.stdout.strip() != kernel_version_before.stdout.strip() }}"

    #################################################################
    # Colored Output
    #################################################################

    - name: Print kernel comparison (ANSI colored)
      ansible.builtin.debug:
        msg: |
          \033[1;34mOld Kernel:\033[0m {{ kernel_version_before.stdout.strip() }}
          \033[1;32mNew Kernel:\033[0m {{ latest_kernel_install.stdout.strip() }}
          {% if reboot_required %}
          \033[1;31mReboot Required: YES\033[0m
          {% else %}
          \033[1;33mReboot Required: NO\033[0m
          {% endif %}

    #################################################################
    # Reboot If Needed
    #################################################################

    - name: Reboot if new kernel detected
      ansible.builtin.reboot:
        msg: "Reboot initiated by Ansible due to new kernel installation"
        reboot_timeout: 600
      when: reboot_required
      ignore_errors: true
