---
- name: Perform OS Maintenance Tasks
  hosts: "{{ hosts.split(';') }}"
  gather_facts: true
  become: true

  vars:
    EXCLUDE_PKGS: "{{ lookup('env', 'EXCLUDE_PKGS') | default('') }}"
    exclude_packages_list: "{{ EXCLUDE_PKGS.split(';') | map('trim') | reject('equalto','') | list }}"

  tasks:

  #####################################################################
  # OS Detection
  #####################################################################

  - name: Check the OS
    debug:
      msg: "Detected OS Family: {{ ansible_facts['os_family'] }}"

  #####################################################################
  # SNAP CLEANUP (Debian Only)
  #####################################################################

  - name: Remove disabled snaps (Debian-based systems)
    shell: snap list --all | awk '/disabled/{print $1, $3}'
    register: disabled_snaps
    changed_when: false
    when: ansible_facts['os_family'] == "Debian"

  - name: Remove disabled snap revisions
    shell: snap remove {{ item.split()[0] }} --revision={{ item.split()[1] }}
    loop: "{{ disabled_snaps.stdout_lines }}"
    ignore_errors: true
    when:
      - ansible_facts['os_family'] == "Debian"
      - disabled_snaps.stdout_lines | length > 0

  #####################################################################
  # SYSTEM CLEANUP
  #####################################################################

  - name: Vacuum journal logs to 20M
    shell: journalctl --vacuum-size=20M
    changed_when: false

  - name: Fix broken packages (Debian-based systems)
    shell: DEBIAN_FRONTEND=noninteractive dpkg --configure -a
    changed_when: false
    when: ansible_facts['os_family'] == "Debian"

  #####################################################################
  # PACKAGE UPDATE
  #####################################################################

  - name: Perform apt update and dist-upgrade (Debian-based systems)
    apt:
      update_cache: yes
      upgrade: dist
    when: ansible_facts['os_family'] == "Debian"

  - name: Perform yum update (RHEL 7 and below)
    yum:
      name: "*"
      state: latest
    when:
      - ansible_facts['os_family'] == "RedHat"
      - ansible_facts['distribution_major_version'] | int < 8

  - name: Perform dnf update (RHEL 8+)
    dnf:
      name: "*"
      state: latest
    when:
      - ansible_facts['os_family'] == "RedHat"
      - ansible_facts['distribution_major_version'] | int >= 8

  #####################################################################
  # HOLD EXCLUDED PACKAGES (Debian Only)
  #####################################################################

  - name: Hold specified packages
    command: apt-mark hold {{ item }}
    loop: "{{ exclude_packages_list }}"
    when:
      - ansible_facts['os_family'] == "Debian"
      - exclude_packages_list | length > 0
    ignore_errors: true

  #####################################################################
  # KERNEL CHECK
  #####################################################################

  - name: Get running kernel version
    command: uname -r
    register: kernel_version_before
    changed_when: false

  - name: Get latest installed kernel (Debian-based systems)
    shell: |
      dpkg -l 'linux-image-*' | awk '/^ii/{print $2}' | sort -V | tail -n1 | sed 's/linux-image-//'
    register: latest_kernel_install
    changed_when: false
    when: ansible_facts['os_family'] == "Debian"

  - name: Get latest installed kernel (RedHat-based systems)
    shell: |
      rpm -q kernel | sort -V | tail -n1 | sed 's/kernel-//'
    register: latest_kernel_install
    changed_when: false
    when: ansible_facts['os_family'] == "RedHat"

  - name: Determine if reboot is required
    set_fact:
      reboot_required: "{{ latest_kernel_install.stdout.strip() != kernel_version_before.stdout.strip() }}"

  #####################################################################
  # COLORED OUTPUT
  #####################################################################

  - name: Print kernel comparison (ANSI colored)
    debug:
      msg: |
        \033[1;34mOld Kernel:\033[0m {{ kernel_version_before.stdout.strip() }}
        \033[1;32mNew Kernel:\033[0m {{ latest_kernel_install.stdout.strip() }}
        {% if reboot_required %}
        \033[1;31mReboot Required: YES\033[0m
        {% else %}
        \033[1;33mReboot Required: NO\033[0m
        {% endif %}

  #####################################################################
  # REBOOT IF REQUIRED
  #####################################################################

  - name: Reboot if new kernel detected
    reboot:
      msg: "Reboot initiated by Ansible due to new kernel installation"
      reboot_timeout: 600
    when: reboot_required
