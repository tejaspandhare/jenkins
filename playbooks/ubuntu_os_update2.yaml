---
- name: Cross Platform OS Maintenance
  hosts: "{{ hosts.split(';') }}"
  gather_facts: true
  become: true

  vars:
    EXCLUDE_PKGS: "{{ lookup('env', 'EXCLUDE_PKGS') | default('') }}"
    exclude_packages_list: "{{ EXCLUDE_PKGS.split(';') | map('trim') | reject('equalto','') | list }}"

  tasks:

  #####################################################################
  # DISPLAY OS INFO
  #####################################################################

  - name: Display detected OS information
    debug:
      msg:
        - "OS Family: {{ ansible_facts['os_family'] }}"
        - "Distribution: {{ ansible_facts['distribution'] }}"
        - "Version: {{ ansible_facts['distribution_version'] }}"

  #####################################################################
  # PACKAGE UPDATES
  #####################################################################

  # Debian / Ubuntu
  - name: Update and upgrade (Debian-based)
    apt:
      update_cache: yes
      upgrade: dist
    when: ansible_facts['os_family'] == "Debian"

  # RHEL 7 and below
  - name: Update packages using yum (RHEL 7 and below)
    yum:
      name: "*"
      state: latest
    when:
      - ansible_facts['os_family'] == "RedHat"
      - ansible_facts['distribution_major_version'] | int < 8

  # RHEL 8+ / Rocky / Alma
  - name: Update packages using dnf (RHEL 8+)
    dnf:
      name: "*"
      state: latest
    when:
      - ansible_facts['os_family'] == "RedHat"
      - ansible_facts['distribution_major_version'] | int >= 8

  # SUSE / SLES / openSUSE
  - name: Update packages using zypper (SUSE-based)
    zypper:
      name: "*"
      state: latest
    when: ansible_facts['os_family'] == "Suse"

  #####################################################################
  # HOLD PACKAGES (Debian Only)
  #####################################################################

  - name: Hold excluded packages (Debian-based)
    command: apt-mark hold {{ item }}
    loop: "{{ exclude_packages_list }}"
    when:
      - ansible_facts['os_family'] == "Debian"
      - exclude_packages_list | length > 0
    ignore_errors: true

  #####################################################################
  # KERNEL CHECK SECTION
  #####################################################################

  - name: Get running kernel version (Old Kernel)
    command: uname -r
    register: running_kernel
    changed_when: false

  ############################################################
  # Get latest installed kernel per OS
  ############################################################

  # Debian / Ubuntu
  - name: Get latest installed kernel (Debian-based)
    shell: |
      dpkg -l 'linux-image-*' | awk '/^ii/{print $2}' | sort -V | tail -n1 | sed 's/linux-image-//'
    register: latest_kernel
    changed_when: false
    when: ansible_facts['os_family'] == "Debian"

  # RHEL / Rocky / Alma / CentOS
  - name: Get latest installed kernel (RedHat-based)
    shell: |
      rpm -q kernel | sort -V | tail -n1 | sed 's/kernel-//'
    register: latest_kernel
    changed_when: false
    when: ansible_facts['os_family'] == "RedHat"

  # SUSE / openSUSE / SLES
  - name: Get latest installed kernel (SUSE-based)
    shell: |
      rpm -q kernel-default | sort -V | tail -n1 | sed 's/kernel-default-//'
    register: latest_kernel
    changed_when: false
    when: ansible_facts['os_family'] == "Suse"

  ############################################################
  # Compare kernels
  ############################################################

  - name: Determine if reboot is required
    set_fact:
      reboot_required: "{{ running_kernel.stdout.strip() != latest_kernel.stdout.strip() }}"

  #####################################################################
  # ALWAYS PRINT OLD + NEW KERNEL
  #####################################################################

  - name: Display kernel comparison (ANSI colored)
    debug:
      msg: |
        \033[1;34mOld (Running) Kernel:\033[0m {{ running_kernel.stdout.strip() }}
        \033[1;32mNew (Installed) Kernel:\033[0m {{ latest_kernel.stdout.strip() }}
        {% if reboot_required %}
        \033[1;31mReboot Required: YES\033[0m
        {% else %}
        \033[1;33mReboot Required: NO\033[0m
        {% endif %}

  #####################################################################
  # REBOOT IF NEW KERNEL DETECTED
  #####################################################################

  - name: Reboot system if new kernel detected
    reboot:
      msg: "Reboot triggered by Ansible (new kernel installed)"
      reboot_timeout: 900
    when: reboot_required | default(false)
